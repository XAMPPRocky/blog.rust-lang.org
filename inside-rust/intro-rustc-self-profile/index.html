<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title></title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta name="description" content="Empowering everyone to build reliable and efficient software.">
     <!-- Twitter card -->
 <meta name="twitter:card" content="summary">
 <meta name="twitter:site" content="@rustlang">
 <meta name="twitter:creator" content="@rustlang">
 <meta name="twitter:title" content="">
 <meta name="twitter:description" content="">
<meta name="twitter:image" content="https://www.rust-lang.org/static/images/rust-social.jpg">

<!-- Facebook OpenGraph -->
<meta property="og:title" content="" />
<meta property="og:description" content="">
<meta property="og:image" content="https://www.rust-lang.org/static/images/rust-social-wide.jpg" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />

<!-- fonts -->
<link rel="preload" as="font" crossorigin href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;fonts&#x2F;AlfaSlabOne-Regular.ttf">
<link rel="preload" as="font" crossorigin href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;fonts&#x2F;FiraSans-ExtraBold.ttf">
<link rel="preload" as="font" crossorigin href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;fonts&#x2F;FiraSans-ExtraBoldItalic.ttf">
<link rel="preload" as="font" crossorigin href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;fonts&#x2F;FiraSans-Italic.ttf">
<link rel="preload" as="font" crossorigin href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;fonts&#x2F;FiraSans-Italic.ttf">
<link rel="preload" as="font" crossorigin href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;fonts&#x2F;FiraSans-Regular.ttf">
<link rel="preload" as="font" crossorigin href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;fonts&#x2F;FiraSans-SemiBold.ttf">
<link rel="preload" as="font" crossorigin href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;fonts&#x2F;FiraSans-SemiBoldItalic.ttf">

<!-- styles -->
<link rel="stylesheet" href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;styles&#x2F;skeleton.css"/>
<link rel="stylesheet" href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;styles&#x2F;tachyons.css"/>
<link rel="stylesheet" href="xampprocky.github.io&#x2F;blog.rust-lang.org/fonts.css"/>
<link rel="stylesheet" href="xampprocky.github.io&#x2F;blog.rust-lang.org/app.css"/>

<!-- favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;images&#x2F;apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;images&#x2F;favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;images&#x2F;favicon-16x16.png">
<link rel="shortcut icon" href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;images&#x2F;favicon.ico">
<link rel="manifest" href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;images&#x2F;site.webmanifest">
<link rel="mask-icon" color="#5bbad5" href="xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;images&#x2F;safari-pinned-tab.svg">
<meta name="msapplication-TileColor" content="#00aba9">
<meta name="theme-color" content="#ffffff">

 <!-- atom -->
 <link type="application/atom+xml" title="" rel="alternate" href="https://blog.rust-lang.org/feed.xml">

  </head>
  <body>
      <nav class="flex flex-row justify-center justify-end-l items-center flex-wrap ph2 pl3-ns pr4-ns">
          <div class="brand flex-auto w-100 w-auto-l self-start tc tl-l">
              <a href="
xampprocky.github.io&#x2F;blog.rust-lang.org&#x2F;inside-rust&#x2F;
">
                  <img class="v-mid ml0-l" alt="Rust Logo" src="/images/rust-logo-blk.svg">
                  <span class="dib ml1 ml0-l">Inside Rust Blog</span>
              </a>
          </div>

          <ul class="nav list w-100 w-auto-l flex flex-none flex-row flex-wrap justify-center justify-end-l items-center pv2 ph0 ph4-ns">
              <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://www.rust-lang.org">Rust</a></li>
              <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://www.rust-lang.org/tools/install">Install</a></li>
              <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://www.rust-lang.org/learn">Learn</a></li>
              <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://www.rust-lang.org/tools">Tools</a></li>
              <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://www.rust-lang.org/governance">Governance</a></li>
              <li class="tc pv2 ph2 ph4-ns flex-20-s"><a href="https://www.rust-lang.org/community">Community</a></li>
          </ul>
      </nav>
      
<section id="Intro to rustc&#x27;s self profiler" class="white">
  <div class="w-100 mw-none ph3 mw8-m mw8-l center f3">
    <header>
      <h2>Intro to rustc&#x27;s self profiler</h2>
      <div class="highlight"></div>
    </header>

    <div class="publish-date-author">Feb. 25 &middot; Wesley Wiser

    

        
        
        
        

        
            
        

        
            
        

        on behalf of the <a href="https:&#x2F;&#x2F;www.rust-lang.org&#x2F;governance&#x2F;teams&#x2F;compiler#wg-self-profile">Self-profile working group</a>.
    
    </div>

    <div class="post">
      <p>Over the last year, the <a href="https://rust-lang.github.io/compiler-team/working-groups/self-profile/">Self-Profile Working Group</a> has been building tools to profile <code>rustc</code> because we often hear requests to know where compilation time is being spent.
This is useful when optimizing the compiler, one of the Compiler Team's ongoing efforts to improve compile times, but it's also useful to users who want to refactor their crate so that it will compile faster.
We've been working on a new feature that will help with that and this blog post gives a preview of how it works.
Be warned, though: it is still experimental and we expect the interface to change over time.
The Rust Unstable Book has <a href="https://doc.rust-lang.org/nightly/unstable-book/compiler-flags/self-profile.html">documentation for this feature</a> and we'll keep that up to date so you can always find the latest instructions there.</p>
<p>In this post, we'll look at the tools currently available and use them to profile <code>rustc</code> while it compiles an example crate.</p>
<h2 id="setup">Setup</h2>
<p>First, we'll install the tools we're going to use from the <code>measureme</code> repository to analyze self-profile trace data.</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> cargo install</span><span style="color:#bf616a;"> --git</span><span style="color:#c0c5ce;"> https://github.com/rust-lang/measureme crox flamegraph summarize
</span></pre>
<p>Now that we have our tools, let's download an example crate to profile its build.</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> cd ..
</span><span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> git clone https://github.com/rust-lang/regex.git
</span><span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> cd regex
</span></pre>
<p>We'll need to use a recent nightly compiler to get access to unstable <code>-Z</code> flags.</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> rustup override set nightly
</span></pre>
<p>If you haven't installed a nightly compiler before, this will download the nightly compiler for you.
If you have, then update it to make sure you're on a recent version.</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> rustup update nightly
</span></pre><h2 id="profiling-the-compiler">Profiling the compiler</h2>
<p>Now we can build it and tell <code>rustc</code> to profile the build of the <code>regex</code> crate.
This will cause three new files to be created in the working directory which contain the profling data.</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> cargo rustc -- -Zself-profile
</span><span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> ls
</span><span style="color:#bf616a;">CHANGELOG.md</span><span style="color:#c0c5ce;">        LICENSE-APACHE       UNICODE.md              regex-17088.string_data       regex-syntax         target
</span><span style="color:#bf616a;">Cargo.lock</span><span style="color:#c0c5ce;">          LICENSE-MIT          bench                   regex-17088.string_index      rustfmt.toml         test
</span><span style="color:#bf616a;">Cargo.toml</span><span style="color:#c0c5ce;">          PERFORMANCE.md       examples                regex-capi                    scripts              tests
</span><span style="color:#bf616a;">HACKING.md</span><span style="color:#c0c5ce;">          README.md            regex-17088.events      regex-debug                   src
</span></pre>
<p>The new files follow the format <code>{crate name}-{rustc process id}.{events,string_data,string_index}</code>.</p>
<p>We'll use each of the three main tools to analyze the profiling data:</p>
<h3 id="summarize"><code>summarize</code></h3>
<p>As its name suggests, this tool summarizes the data found in the trace files.
Additionally, <code>summarize</code> can also show a &quot;diff&quot; between two trace files but we won't be using this mode.</p>
<p>Let's run the tool, passing just the file name (but not the extension) for the trace:</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> summarize summarize regex-17088
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">Item                                          </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">Self</span><span style="color:#c0c5ce;"> time | % of total time | </span><span style="color:#bf616a;">Time     </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">Item</span><span style="color:#c0c5ce;"> count |
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">LLVM_module_codegen_emit_obj                  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">4.89s     </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">42.752          </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">4.89s    </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">159        </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">codegen_module                                </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1.25s     </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">10.967          </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1.37s    </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">159        </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">LLVM_module_optimize_module_passes            </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1.15s     </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">10.022          </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1.15s    </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">159        </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">LLVM_module_codegen_make_bitcode              </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">786.56ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">6.875           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">960.73ms </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">159        </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">typeck_tables_of                              </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">565.18ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">4.940           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">689.39ms </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">848        </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">LLVM_module_codegen                           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">408.01ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">3.566           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">6.26s    </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">159        </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">mir_borrowck                                  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">224.03ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1.958           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">543.33ms </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">848        </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">LLVM_module_codegen_emit_compressed_bitcode   </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">174.17ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1.522           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">174.17ms </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">159        </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">optimized_mir                                 </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">157.91ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1.380           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">205.29ms </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1996       </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">evaluate_obligation                           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">146.50ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1.281           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">184.17ms </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">8304       </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">codegen_crate                                 </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">139.48ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1.219           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1.58s    </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1          </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">mir_built                                     </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">123.88ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1.083           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">168.01ms </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">848        </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">metadata_decode_entry                         </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">88.36ms   </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">0.772           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">117.77ms </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">55642      </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">incr_comp_copy_cgu_workproducts               </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">64.21ms   </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">0.561           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">64.21ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1          </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">monomorphization_collector_graph_walk         </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">54.11ms   </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">0.473           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">344.00ms </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1          </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">link_rlib                                     </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">43.21ms   </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">0.378           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">43.21ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1          </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">check_impl_item_well_formed                   </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">41.36ms   </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">0.362           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">77.14ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">736        </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">codegen_fulfill_obligation                    </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">40.36ms   </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">0.353           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">51.56ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1759       </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">expand_crate                                  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">37.24ms   </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">0.326           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">48.52ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1          </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">symbol_name                                   </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">36.31ms   </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">0.317           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">39.06ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">5513       </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
</span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">free_global_ctxt                              </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">34.34ms   </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">0.300           </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">34.34ms  </span><span style="color:#c0c5ce;">| </span><span style="color:#bf616a;">1          </span><span style="color:#c0c5ce;">|
</span><span style="color:#bf616a;">+-----------------------------------------------+-----------+-----------------+----------+------------+
...
Total</span><span style="color:#c0c5ce;"> cpu time: 11.440758871s
</span></pre>
<p>The output is sorted by the self time (time spent in the query or activity but not other queries or activities called by itself).
As you can see, most of the compilation time is spent in LLVM generating the binary code for the executable.</p>
<h3 id="flamegraph"><code>flamegraph</code></h3>
<p>As you may have guessed, <code>flamegraph</code> will produce a <a href="http://www.brendangregg.com/flamegraphs.html">flame graph</a> of the profiling data.
To run the tool, we'll pass just the filename without a file extension like we did for <code>summarize</code>:</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> flamegraph regex-17088
</span></pre>
<p>This will create a file called <code>rustc.svg</code> in the working directory:</p>
<p><a href="/images/inside-rust/2020-02-25-intro-rustc-self-profile/flamegraph_image.png"><img src="/images/inside-rust/2020-02-25-intro-rustc-self-profile/flamegraph_image.png" alt="Image of flamegraph output" /></a></p>
<p><a href="/images/inside-rust/2020-02-25-intro-rustc-self-profile/rustc.svg">Click here</a> to try the interactive svg.</p>
<h3 id="crox"><code>crox</code></h3>
<p>This tool processes self-profiling data into the JSON format that the Chromium profiler understands.
You can use it to create a graphical timeline showing exactly when various traced events occurred.</p>
<p>In this section, we'll cover a few different modes <code>crox</code> can run in such as profiling an entire crate compilation including dependencies and filtering out small events.
Let's get started with the basics!</p>
<h4 id="basic-usage">Basic usage</h4>
<p>To run the tool, we'll just pass the filename without a file extension like we've done before:</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> crox regex-17088
</span></pre>
<p>This creates a file called <code>chrome_profiler.json</code> in the working directory.
To open it, we'll use the regular Chromium performance tools you might already be familiar with:</p>
<ol>
<li>Open Chrome</li>
<li>Open the Developer Tools console by pressing <code>Ctrl</code> + <code>Shift</code> + <code>i</code> (Windows/Linux) or <code>Cmd</code> + <code>Option</code> + <code>i</code> (macOS)</li>
<li>Click the Performance tab at the top of the console.</li>
<li>Click the &quot;Load profile&quot; button which looks like an arrow pointing up.</li>
<li>Select the <code>chrome_profiler.json</code> file we created.</li>
</ol>
<p>You should now see something similar to this:</p>
<p><a href="/images/inside-rust/2020-02-25-intro-rustc-self-profile/chrome_profiler1.png"><img src="/images/inside-rust/2020-02-25-intro-rustc-self-profile/chrome_profiler1.png" alt="Image of chrome profiler" /></a></p>
<p>You can use the scroll wheel on a mouse or the appropriate gesture on a touchpad to zoom in or out of the timeline.</p>
<h4 id="filtering-short-events">Filtering short events</h4>
<p>If the <code>chrome_profiler.json</code> file gets too large, the normal Chromium performance tools have issues opening the file.
One easy way to deal with this is to tell <code>crox</code> to remove events shorter than a chosen duration:</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> crox</span><span style="color:#bf616a;"> --minimum-duration</span><span style="color:#c0c5ce;"> 2 regex-17088
</span></pre>
<p>Filtering out events less than 2 microseconds shrinks our <code>chrome_profiler.js</code> file from 27mb to 11mb.</p>
<h4 id="capturing-event-arguments">Capturing event arguments</h4>
<p>The self-profiler can be configured to record event arguments during compilation.
For example, queries will include their query key.
This functionality is turned off by default because it increases the self-profiler overhead.</p>
<p>To turn this feature on, we'll need to record a new compilation, passing an additional argument to <code>rustc</code>:</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> cargo clean
</span><span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> cargo rustc -- -Zself-profile -Zself-profile-events=default,args
</span></pre>
<p>And then process the new output files:</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> crox regex-23649
</span></pre>
<p>Now in the Chromium profiler, if you click on a node, you can see additional data about many of the events at the bottom of the screen:</p>
<p><a href="/images/inside-rust/2020-02-25-intro-rustc-self-profile/chrome_profiler2.png"><img src="/images/inside-rust/2020-02-25-intro-rustc-self-profile/chrome_profiler2.png" alt="Image of Chrome profiler details" /></a></p>
<p>Which shows this <code>optimized_mir</code> query was processing the <code>regex::compile::{{impl}}::new</code> function body.</p>
<h4 id="profiling-an-entire-crate-graph">Profiling an entire crate graph</h4>
<p>By using the <code>RUSTFLAGS</code> environment variable, we can profile every <code>rustc</code> invocation, not just the final crate's.
<code>crox</code> can then combine all of the profiles together into one output file.
Since this will create a lot of files, we'll tell <code>rustc</code> to create a folder to put all the traces in.</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> rm regex-17088.* regex-23649.* </span><span style="color:#65737e;"># clean up the old trace files since we&#39;re done with them
</span><span style="color:#c0c5ce;">$ cargo clean
</span><span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> RUSTFLAGS=&quot;</span><span style="color:#a3be8c;">-Zself-profile=</span><span style="color:#c0c5ce;">$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">pwd</span><span style="color:#a3be8c;">)/profiles -Zself-profile-events=default,args</span><span style="color:#c0c5ce;">&quot; cargo build
</span></pre>
<p>This creates quite a few trace files in the working directory.
Now, we'll tell <code>crox</code> to combine all of the trace files in the current directory together:</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">$</span><span style="color:#c0c5ce;"> crox</span><span style="color:#bf616a;"> --dir</span><span style="color:#c0c5ce;"> profiles
</span></pre>
<p>Opening this file shows all of the crates compiled:</p>
<p><a href="/images/inside-rust/2020-02-25-intro-rustc-self-profile/chrome_profiler3.png"><img src="/images/inside-rust/2020-02-25-intro-rustc-self-profile/chrome_profiler3.png" alt="Image of Chrome profiler with all crates" /></a></p>
<p>Clicking on a crate will expand it to show the threads and event data inside it:</p>
<p><a href="/images/inside-rust/2020-02-25-intro-rustc-self-profile/chrome_profiler4.png"><img src="/images/inside-rust/2020-02-25-intro-rustc-self-profile/chrome_profiler4.png" alt="Image of Chrome profiler with a crate expanded" /></a></p>
<p>Thanks for reading!</p>
<p>We've been using these tools extensively ourselves over the last few months and they've helped us tremendously in understanding where the compiler spends its time.
In the future we'll be adding more features and we'll work on making the tooling easier to use.
If you have questions or would like to get involved with the Self-Profile Working Group, please check out the <a href="https://github.com/rust-lang/measureme">measureme repository</a> or stop by our <a href="https://rust-lang.zulipchat.com/#narrow/stream/187831-t-compiler.2Fwg-self-profile">Zulip stream</a>.</p>

    </div>
  </div>
</section>

      <footer>
  <div class="w-100 mw-none ph3 mw8-m mw9-l center f3">
    <div class="row">
      <div class="four columns mt3 mt0-l" id="get-help">
        <h4>Get help!</h4>
        <ul>
          <li><a href="https://doc.rust-lang.org" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="mailto:core-team@rust-lang.org">Contact the Rust Team</a></li>
          <li><a href="http://ping.rust-lang.org">Check Website Status</a></li>
        </ul>
      </div>
      <div class="four columns mt3 mt0-l">
        <h4>Terms and policies</h4>
        <ul>
          <li><a href="https://www.rust-lang.org/policies/code-of-conduct">Code of Conduct</a></li>
          <li><a href="https://www.rust-lang.org/policies/licenses">Licenses</a></li>
          <li><a href="https://www.rust-lang.org/policies/media-guide">Logo Policy and Media Guide</a></li>
          <li><a href="https://www.rust-lang.org/policies/security">Security Disclosures</a></li>
          <li><a href="https://www.rust-lang.org/policies">All Policies</a></li>
        </ul>
      </div>
      <div class="four columns mt3 mt0-l">
        <h4>Social</h4>
        <a href="https://twitter.com/rustlang" target="_blank" rel="noopener" alt="twitter link"><img src="/images/twitter.svg" alt="twitter logo" title="Twitter"/></a>
        <a href="https://www.youtube.com/channel/UCaYhcUwRBNscFNUKTjgPFiA" target="_blank" rel="noopener" alt="youtube link"><img style="padding-top: 6px; padding-bottom:6px" src="/images/youtube.svg" alt="youtube logo" title="YouTube"/></a>
        <a href="https://discord.gg/rust-lang" target="_blank" rel="noopener" alt="discord link"><img src="/images/discord.svg" alt="discord logo" title="Discord"/></a>
        <a href="https://github.com/rust-lang" target="_blank" rel="noopener" alt="github link"><img src="/images/github.svg" alt="github logo" title="GitHub"/></a>
      </div>

    </div>
    <div class="attribution">
      Maintained by the Rust Team. See a typo?
      <a href="https://github.com/rust-lang/blog.rust-lang.org" target="_blank" rel="noopener">Send a fix here</a>!
    </div>
  </div>
</footer>

<!-- scripts -->
<script src="/scripts/highlight.js"></script>

  </body>
</html>
